name: CI

on: [push]

jobs:
 test:
    runs-on: macOS-latest
    strategy:
      matrix:
        destination: ['platform=iOS Simulator,name=iPhone 12,OS=14.3', 'platform=iOS Simulator,name=iPhone 11,OS=13.7']
    steps:
    - name: Prepare iOS 13 simulator
      run: |
        sudo mkdir -p /Library/Developer/CoreSimulator/Profiles/Runtimes
        sudo ln -s /Applications/Xcode_11.7.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime /Library/Developer/CoreSimulator/Profiles/Runtimes/iOS\ 13.7.simruntime
        xcrun simctl list runtimes
        xcrun simctl create ios13-iphone11-simulator "iPhone 11 (com.apple.CoreSimulator.SimDeviceType.iPhone-11)" "com.apple.CoreSimulator.SimRuntime.iOS-13-7"
        xcrun simctl list devices 13.7
    - uses: actions/checkout@master
    - uses: maxim-lobanov/setup-xcode@v1.2.1
      with:
        xcode-version: 12.3
    - name: Test StylableSwiftUI
      shell: bash
      run: |
        pushd Example
        set -o pipefail && xcodebuild test -enableCodeCoverage YES -workspace ${workspace} -scheme ${scheme} -destination "${destination}" | xcpretty --color
        popd
        pod lib lint --allow-warnings
      env:
        destination: ${{ matrix.destination }}
        scheme: "StylableSwiftUI-Example"
        workspace: "StylableSwiftUI.xcworkspace"
        ONLY_ACTIVE_ARCH: "NO"
        CODE_SIGN_IDENTITY: ""
        CODE_SIGNING_REQUIRED: "NO" 

